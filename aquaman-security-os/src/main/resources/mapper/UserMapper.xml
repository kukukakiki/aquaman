<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aquaman.security.admin.mapper.UserMapper">

    <sql id="Base_Column_List">
    t.id, t.account, t.name, t.password, t.nick_name, t.mobile, t.email, t.dept_id, t.status, t.type, t.login_time,
    t.permission_code, t.gmt_create, t.gmt_modify
    </sql>


    <resultMap id="ResultUserFullInfo" type="com.aquaman.security.admin.entity.dto.UserFullInfoDTO">
    </resultMap>

    <sql id="Base_Where_List">
        1=1
        <if test="account != null and account != ''">
            and account = #{account,jdbcType=VARCHAR}
        </if>
        <if test="nickName != null and nickName != ''">
            and nick_name = #{nickName,jdbcType=VARCHAR}
        </if>
        <if test="mobile != null and mobile != ''">
            and mobile = #{mobile,jdbcType=VARCHAR}
        </if>
        <if test="email != null and email != ''">
            and email = #{email,jdbcType=VARCHAR}
        </if>
        <if test="deptId != null and deptId != ''">
            and dept_id = #{deptId,jdbcType=BIGINT}
        </if>
        <if test="status != null and status != ''">
            and status = #{status,jdbcType=VARCHAR}
        </if>
        <if test="type != null and type != ''">
            and type = #{type,jdbcType=VARCHAR}
        </if>
        <if test="loginTime != null and loginTime != ''">
            and login_time = #{loginTime,jdbcType=BIGINT}
        </if>
        <if test="permissionCode != null">
            and permission_code = #{permissionCode,jdbcType=VARCHAR}
        </if>
        <if test="gmtModify != null and gmt_modify != ''">
            and gmt_modify = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
        </if>
    </sql>
    <!-- 根据用户名获取用户信息 -->
    <select id="loadUserByAccount" parameterType="java.lang.String" resultType="com.aquaman.security.admin.entity.domain.User">
    select
    <include refid="Base_Column_List" />
    from ad_user t
    where account = #{account,jdbcType=VARCHAR}
    </select>

    <select id="findUserByPage" resultType="com.aquaman.security.admin.entity.domain.User">
        select
        <include refid="Base_Column_List" />
        from ad_user t
        where <include refid="Base_Where_List" />
    </select>

    <select id="findUserByDeptId" resultType="com.aquaman.security.admin.entity.domain.User">
        select
        <include refid="Base_Column_List" />
        from ad_user t, ad_dept d where t.dept_id = d.id and d.id = #{deptId,jdbcType=BIGINT}
    </select>

    <update id="updateLoginTime" parameterType="java.lang.Long">
        update ad_user t set login_time = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') where t.id = #{id,jdbcType=BIGINT}
    </update>

    <select id="findUserFullInfoByAccount" parameterType="java.lang.String"  resultMap="ResultUserFullInfo">
        select <include refid="Base_Column_List" />, ur.id as user_role_id, ur.role_ids,
            GROUP_CONCAT(rm.menu_ids) as menu_ids,d.name, d.id dept_id
        from
            ad_user t,
            ad_user_role ur,
            ad_role_menu rm,
            ad_dept d
        WHERE
            ur.user_id = id
        AND du.dept_id = d.id
        AND t.account = #{account,jdbcType=VARCHAR}
        AND FIND_IN_SET(rm.role_id, ur.role_ids)
        AND FIND_IN_SET(id, du.user_ids)
        AND t.dept_id = d.id
    </select>

</mapper>